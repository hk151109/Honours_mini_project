{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/heemi/Downloads/enviro-meter/app/api/sentinel-image/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport fetch from \"node-fetch\";\r\n\r\ninterface TokenResponse {\r\n  access_token: string;\r\n}\r\n\r\n// Generate next filename like true-color-1.png, true-color-2.png, ...\r\nasync function getNextFilename() {\r\n  const dir = path.join(process.cwd(), \"public\", \"sentinel\");\r\n\r\n  if (!fs.existsSync(dir)) {\r\n    fs.mkdirSync(dir, { recursive: true });\r\n  }\r\n\r\n  const files = fs.readdirSync(dir)\r\n    .filter(f => f.startsWith(\"true-color-\") && f.endsWith(\".png\"));\r\n\r\n  const numbers = files\r\n    .map(f => parseInt(f.replace(\"true-color-\", \"\").replace(\".png\", \"\")))\r\n    .filter(n => !isNaN(n));\r\n\r\n  const next = numbers.length > 0 ? Math.max(...numbers) + 1 : 1;\r\n\r\n  return `true-color-${next}.png`;\r\n}\r\n\r\nasync function downloadImage(imageBase64: string, filename: string) {\r\n  const buffer = Buffer.from(imageBase64.split(\",\")[1], \"base64\");\r\n\r\n  const filePath = path.join(process.cwd(), \"public\", \"sentinel\", filename);\r\n\r\n  if (!fs.existsSync(path.dirname(filePath))) {\r\n    fs.mkdirSync(path.dirname(filePath), { recursive: true });\r\n  }\r\n\r\n  fs.writeFileSync(filePath, buffer);\r\n\r\n  return `/sentinel/${filename}`;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { lat1, lon1, lat2, lon2 } = await req.json();\r\n\r\n    const minLat = Math.min(lat1, lat2);\r\n    const maxLat = Math.max(lat1, lat2);\r\n    const minLon = Math.min(lon1, lon2);\r\n    const maxLon = Math.max(lon1, lon2);\r\n    const bbox = [minLon, minLat, maxLon, maxLat];\r\n\r\n    const CLIENT_ID = process.env.SENTINELHUB_CLIENT_ID!;\r\n    const CLIENT_SECRET = process.env.SENTINELHUB_CLIENT_SECRET!;\r\n\r\n    // Authenticate\r\n    const tokenRes = await fetch(\"https://services.sentinel-hub.com/oauth/token\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n      body: new URLSearchParams({\r\n        grant_type: \"client_credentials\",\r\n        client_id: CLIENT_ID,\r\n        client_secret: CLIENT_SECRET,\r\n      }),\r\n    });\r\n\r\n    const tokenData = (await tokenRes.json()) as TokenResponse;\r\n    const access_token = tokenData.access_token;\r\n\r\n    if (!access_token) throw new Error(\"Failed to authenticate with SentinelHub\");\r\n\r\n    // True Color Script\r\n    const evalscriptTrueColor = `\r\n      //VERSION=3\r\n      function setup() {\r\n        return { input: [\"B04\",\"B03\",\"B02\"], output: { bands: 3 } };\r\n      }\r\n      function evaluatePixel(s) {\r\n        return [s.B04 * 2.5, s.B03 * 2.5, s.B02 * 2.5];\r\n      }\r\n    `;\r\n\r\n    async function fetchImage(evalscript: string) {\r\n      const body = {\r\n        input: {\r\n          bounds: {\r\n            bbox,\r\n            properties: { crs: \"http://www.opengis.net/def/crs/EPSG/0/4326\" },\r\n          },\r\n          data: [\r\n            {\r\n              type: \"sentinel-2-l2a\",\r\n              dataFilter: {\r\n                timeRange: {\r\n                  from: new Date(new Date().setMonth(new Date().getMonth() - 2)).toISOString(),\r\n                  to: new Date().toISOString(),\r\n                },\r\n                maxCloudCoverage: 20,\r\n              },\r\n            },\r\n          ],\r\n        },\r\n        output: { width: 512, height: 512, responses: [{ identifier: \"default\", format: { type: \"image/png\" } }] },\r\n        evalscript,\r\n      };\r\n\r\n      const res = await fetch(\"https://services.sentinel-hub.com/api/v1/process\", {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${access_token}`, \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(body),\r\n      });\r\n\r\n      if (!res.ok) throw new Error(await res.text());\r\n\r\n      const buf = await res.arrayBuffer();\r\n      return `data:image/png;base64,${Buffer.from(buf).toString(\"base64\")}`;\r\n    }\r\n\r\n    const trueColorBase64 = await fetchImage(evalscriptTrueColor);\r\n\r\n    // USE AUTO-INCREMENTING FILENAME\r\n    const filename = await getNextFilename();\r\n\r\n    const fileUrl = await downloadImage(trueColorBase64, filename);\r\n\r\n    return NextResponse.json({\r\n      trueColorUrl: fileUrl,\r\n      filename,\r\n      bbox,\r\n    });\r\n\r\n  } catch (err: any) {\r\n    console.error(err);\r\n    return NextResponse.json({ error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}